## 가장 많이하는 실수

```java
Member member = new Member();
member.setUsername("member1");
em.persist(member);

Team team = new Team();
team.setName("TeamA");
team.getMembers().add(member); //??

em.persist(team);
```

여기서 문제를 찾을 수 있나?

- member 테이블의 team_id가 들어가지 않는다.

- team 이 연관관계의 주인인데, list members에 뭔가 수정을 해도 반영되지 않음

- 순서를 바꿔야 한다.

```java

Team team = new Team();
team.setName("TeamA");
em.persist(team);

Member member = new Member();
member.setUsername("member1");
member.setTeam(team); //Member 안에 team 넣기
em.persist(member);
```

- 연관관게 주인에게 값을 넣어야 한다.

## 양방향 매핑을 할때 가급적이면 양쪽에 값을 넣어야 한다.

- 사실 list members에는 넣을 필요 없음(JPA 입장)

  - JPA는 연관관계 주인이 아닌 매핑된 변수를 사용할 때 DB에서 select로 값 가져옴.

  - 그러니까 members에 값 안넣어도 동작하긴 한다.

- 객체지향 입장에서는 양쪽에 값을 다 넣어줘야 한다.

  - em.flush(), em.clear()가 없다면 메모리 상에만 있는 값들은 JPA가 관리하지 않는다.

  - 내가 team을 지정해놓은 것은 1차 캐시에만 들어가 있음
  - members에는 사실상 JPA 도움없이는 아무 값도 들어가지 않는다.

- 양방향 연관관계를 만들 때, 양쪽에 다 값을 세팅해주는게 맞다.

## 순수 객체 상태를 고려하여 항상 양쪽에 값을 설정해야 한다.

- 하지만 귀찮다. 사람이기 때문에 실수할 수도 있음

- 연관관계 작성을 위한 메서드를 만들자.

- Member.setTeam() 메서드에다가, team.getMembers().add(this); 이런식으로

- 양방향 매핑 시, 무한 루프 조심

  - toString() 처럼 양쪽에 구현된 게 있다면, 양쪽으로 무한 루프 출력됨

  - JSON 생성 라이브러리 같은 걸 쓸 때도, JSON depth 무한 증가

  - 무한 루프 관련된건 빼고 쓰기, Controller 는 Entity를 반환하지 말아라

## 양방향 매핑 정리

- 단방향 매핑만으로도 이미 연관관계 매핑은 끝난 것

- 애초에 설계 할 때 양방향으로 하는게 아님.

- 일단 단방향 매핑으로 설계를 완료한다.

- 양방향 매핑은 반대방향 조회가 추가된 것 뿐.

- 나중에 개발하다가 역방향 참조할 일이 많으면, 그 때

- 단방향을 양방향 매핑으로 바꾸는 건 테이블에 영향을 주지 않는다.

- 그러니까 단방향 매핑이 중요

## 연관관계 주인 정하는 기준

- Not 비즈니스 로직

- 외래키의 위치 기준
